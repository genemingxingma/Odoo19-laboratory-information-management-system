<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_lab_task_sla_policy_list" model="ir.ui.view">
        <field name="name">lab.task.sla.policy.list</field>
        <field name="model">lab.task.sla.policy</field>
        <field name="arch" type="xml">
            <list>
                <field name="sequence"/>
                <field name="name"/>
                <field name="code"/>
                <field name="department"/>
                <field name="workstation"/>
                <field name="priority"/>
                <field name="sla_hours"/>
                <field name="active"/>
            </list>
        </field>
    </record>

    <record id="view_lab_task_sla_policy_form" model="ir.ui.view">
        <field name="name">lab.task.sla.policy.form</field>
        <field name="model">lab.task.sla.policy</field>
        <field name="arch" type="xml">
            <form string="Task SLA Policy">
                <sheet>
                    <group>
                        <group>
                            <field name="sequence"/>
                            <field name="name"/>
                            <field name="code"/>
                            <field name="department"/>
                            <field name="workstation"/>
                        </group>
                        <group>
                            <field name="priority"/>
                            <field name="sla_hours"/>
                            <field name="auto_assign_group_id"/>
                            <field name="escalation_group_id"/>
                            <field name="active"/>
                        </group>
                    </group>
                    <group>
                        <field name="note"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_lab_task_sla_policy" model="ir.actions.act_window">
        <field name="name">Task SLA Policies</field>
        <field name="res_model">lab.task.sla.policy</field>
        <field name="view_mode">list,form</field>
    </record>

    <record id="view_lab_workstation_task_list" model="ir.ui.view">
        <field name="name">lab.workstation.task.list</field>
        <field name="model">lab.workstation.task</field>
        <field name="arch" type="xml">
            <list decoration-danger="state in ('overdue','blocked')" decoration-warning="escalated" decoration-success="state == 'done'">
                <field name="name"/>
                <field name="title"/>
                <field name="department"/>
                <field name="workstation"/>
                <field name="priority"/>
                <field name="state"/>
                <field name="sample_id"/>
                <field name="analysis_id"/>
                <field name="interface_job_id"/>
                <field name="assigned_group_id"/>
                <field name="assigned_user_id"/>
                <field name="due_date"/>
                <field name="escalated"/>
            </list>
        </field>
    </record>

    <record id="view_lab_workstation_task_form" model="ir.ui.view">
        <field name="name">lab.workstation.task.form</field>
        <field name="model">lab.workstation.task</field>
        <field name="arch" type="xml">
            <form string="Workstation Task">
                <header>
                    <button name="action_assign_to_me" type="object" string="Assign To Me" invisible="state in ('done','cancel')"/>
                    <button name="action_start" type="object" string="Start" class="btn-primary" invisible="state in ('in_progress','done','cancel')"/>
                    <button name="action_block" type="object" string="Block" invisible="state in ('blocked','done','cancel')"/>
                    <button name="action_unblock" type="object" string="Unblock" invisible="state != 'blocked'"/>
                    <button name="action_done" type="object" string="Done" class="btn-primary" invisible="state in ('done','cancel')"/>
                    <button name="action_escalate" type="object" string="Escalate" invisible="state in ('done','cancel')"/>
                    <button name="action_cancel" type="object" string="Cancel" invisible="state in ('done','cancel')"/>
                    <field name="state" widget="statusbar" statusbar_visible="new,assigned,in_progress,blocked,overdue,done,cancel"/>
                </header>
                <sheet>
                    <group>
                        <group>
                            <field name="name" readonly="1"/>
                            <field name="title"/>
                            <field name="description"/>
                            <field name="department"/>
                            <field name="workstation"/>
                            <field name="priority"/>
                        </group>
                        <group>
                            <field name="source_model" readonly="1"/>
                            <field name="source_res_id" readonly="1"/>
                            <field name="sample_id" readonly="1"/>
                            <field name="analysis_id" readonly="1"/>
                            <field name="request_id" readonly="1"/>
                            <field name="interface_job_id" readonly="1"/>
                            <field name="branch_run_id" readonly="1"/>
                        </group>
                    </group>
                    <group>
                        <group>
                            <field name="policy_id"/>
                            <field name="due_date"/>
                            <field name="is_overdue" readonly="1"/>
                        </group>
                        <group>
                            <field name="assigned_group_id"/>
                            <field name="assigned_user_id"/>
                            <field name="assigned_at" readonly="1"/>
                            <field name="started_at" readonly="1"/>
                            <field name="finished_at" readonly="1"/>
                        </group>
                    </group>
                    <group>
                        <field name="escalated" readonly="1"/>
                        <field name="escalation_note" readonly="1"/>
                    </group>
                    <notebook>
                        <page string="Events">
                            <field name="event_ids" readonly="1">
                                <list>
                                    <field name="event_time"/>
                                    <field name="action"/>
                                    <field name="user_id"/>
                                    <field name="note"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <record id="view_lab_workstation_task_search" model="ir.ui.view">
        <field name="name">lab.workstation.task.search</field>
        <field name="model">lab.workstation.task</field>
        <field name="arch" type="xml">
            <search>
                <field name="title"/>
                <field name="department"/>
                <field name="workstation"/>
                <field name="assigned_user_id"/>
                <field name="state"/>
                <filter name="f_open" string="Open" domain="[('state','in',('new','assigned','in_progress','blocked','overdue'))]"/>
                <filter name="f_overdue" string="Overdue" domain="[('state','=','overdue')]"/>
                <filter name="f_escalated" string="Escalated" domain="[('escalated','=',True)]"/>
                <filter name="f_my" string="My Tasks" domain="[('assigned_user_id','=',uid),('state','not in',('done','cancel'))]"/>
            </search>
        </field>
    </record>

    <record id="action_lab_workstation_task" model="ir.actions.act_window">
        <field name="name">Workstation Tasks</field>
        <field name="res_model">lab.workstation.task</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="view_lab_workstation_task_search"/>
    </record>

    <record id="view_lab_sop_branch_rule_list" model="ir.ui.view">
        <field name="name">lab.sop.branch.rule.list</field>
        <field name="model">lab.sop.branch.rule</field>
        <field name="arch" type="xml">
            <list>
                <field name="sequence"/>
                <field name="name"/>
                <field name="code"/>
                <field name="department"/>
                <field name="sample_type"/>
                <field name="trigger_event"/>
                <field name="action_type"/>
                <field name="target_workstation"/>
                <field name="active"/>
            </list>
        </field>
    </record>

    <record id="view_lab_sop_branch_rule_form" model="ir.ui.view">
        <field name="name">lab.sop.branch.rule.form</field>
        <field name="model">lab.sop.branch.rule</field>
        <field name="arch" type="xml">
            <form string="SOP Branch Rule">
                <sheet>
                    <group>
                        <group>
                            <field name="sequence"/>
                            <field name="name"/>
                            <field name="code"/>
                            <field name="department"/>
                            <field name="sample_type"/>
                            <field name="trigger_event"/>
                        </group>
                        <group>
                            <field name="action_type"/>
                            <field name="target_workstation" invisible="action_type != 'create_task'"/>
                            <field name="task_priority" invisible="action_type != 'create_task'"/>
                            <field name="owner_group_id"/>
                            <field name="ncr_severity" invisible="action_type != 'create_ncr'"/>
                            <field name="active"/>
                        </group>
                    </group>
                    <group>
                        <field name="condition_json" placeholder='{"priority":"stat"}'/>
                        <field name="notify_template" invisible="action_type != 'notify'"/>
                        <field name="note"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_lab_sop_branch_rule" model="ir.actions.act_window">
        <field name="name">SOP Branch Rules</field>
        <field name="res_model">lab.sop.branch.rule</field>
        <field name="view_mode">list,form</field>
    </record>

    <record id="view_lab_sop_branch_run_list" model="ir.ui.view">
        <field name="name">lab.sop.branch.run.list</field>
        <field name="model">lab.sop.branch.run</field>
        <field name="arch" type="xml">
            <list decoration-danger="result_state == 'failed'" decoration-warning="result_state == 'skipped'" decoration-success="result_state == 'executed'">
                <field name="run_time"/>
                <field name="rule_id"/>
                <field name="trigger_event"/>
                <field name="sample_id"/>
                <field name="analysis_id"/>
                <field name="interface_job_id"/>
                <field name="result_state"/>
                <field name="task_id"/>
                <field name="output_note"/>
            </list>
        </field>
    </record>

    <record id="action_lab_sop_branch_run" model="ir.actions.act_window">
        <field name="name">SOP Branch Runs</field>
        <field name="res_model">lab.sop.branch.run</field>
        <field name="view_mode">list</field>
    </record>

    <record id="view_lab_interface_replay_batch_list" model="ir.ui.view">
        <field name="name">lab.interface.replay.batch.list</field>
        <field name="model">lab.interface.replay.batch</field>
        <field name="arch" type="xml">
            <list decoration-warning="state == 'running'" decoration-success="state == 'done'">
                <field name="name"/>
                <field name="endpoint_id"/>
                <field name="state"/>
                <field name="total_count"/>
                <field name="done_count"/>
                <field name="failed_count"/>
                <field name="date_from"/>
                <field name="date_to"/>
            </list>
        </field>
    </record>

    <record id="view_lab_interface_replay_batch_form" model="ir.ui.view">
        <field name="name">lab.interface.replay.batch.form</field>
        <field name="model">lab.interface.replay.batch</field>
        <field name="arch" type="xml">
            <form string="Interface Replay Batch">
                <header>
                    <button name="action_prepare" type="object" string="Prepare" class="btn-primary" invisible="state not in ('draft','prepared')"/>
                    <button name="action_execute" type="object" string="Execute" invisible="state != 'prepared'"/>
                    <button name="action_cancel" type="object" string="Cancel" invisible="state in ('done','cancel')"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,prepared,running,done,cancel"/>
                </header>
                <sheet>
                    <group>
                        <group>
                            <field name="name"/>
                            <field name="endpoint_id"/>
                            <field name="date_from"/>
                            <field name="date_to"/>
                        </group>
                        <group>
                            <field name="include_failed"/>
                            <field name="include_dead_letter"/>
                            <field name="total_count" readonly="1"/>
                            <field name="done_count" readonly="1"/>
                            <field name="failed_count" readonly="1"/>
                        </group>
                    </group>
                    <group>
                        <field name="reason"/>
                    </group>
                    <notebook>
                        <page string="Lines">
                            <field name="line_ids" readonly="state in ('running','done','cancel')">
                                <list>
                                    <field name="job_id"/>
                                    <field name="state"/>
                                    <field name="result_note"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <record id="action_lab_interface_replay_batch" model="ir.actions.act_window">
        <field name="name">Interface Replay Batches</field>
        <field name="res_model">lab.interface.replay.batch</field>
        <field name="view_mode">list,form</field>
    </record>

    <record id="view_lab_task_board_wizard_form" model="ir.ui.view">
        <field name="name">lab.task.board.wizard.form</field>
        <field name="model">lab.task.board.wizard</field>
        <field name="arch" type="xml">
            <form string="Task Board" create="0" edit="0" delete="0">
                <sheet>
                    <group>
                        <group>
                            <field name="department"/>
                            <field name="workstation"/>
                        </group>
                        <group>
                            <button name="action_refresh" type="object" string="Refresh" class="btn-primary"/>
                        </group>
                    </group>
                    <group>
                        <group>
                            <field name="new_count" readonly="1"/>
                            <button name="action_open_new" type="object" string="Open"/>
                        </group>
                        <group>
                            <field name="assigned_count" readonly="1"/>
                            <button name="action_open_assigned" type="object" string="Open"/>
                        </group>
                    </group>
                    <group>
                        <group>
                            <field name="in_progress_count" readonly="1"/>
                            <button name="action_open_in_progress" type="object" string="Open"/>
                        </group>
                        <group>
                            <field name="blocked_count" readonly="1"/>
                            <button name="action_open_blocked" type="object" string="Open"/>
                        </group>
                    </group>
                    <group>
                        <group>
                            <field name="overdue_count" readonly="1"/>
                            <button name="action_open_overdue" type="object" string="Open"/>
                        </group>
                        <group>
                            <field name="escalated_count" readonly="1"/>
                        </group>
                    </group>
                </sheet>
                <footer>
                    <button special="cancel" string="Close"/>
                </footer>
            </form>
        </field>
    </record>

    <record id="action_lab_task_board_wizard" model="ir.actions.act_window">
        <field name="name">Task Board</field>
        <field name="res_model">lab.task.board.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>

    <record id="view_lab_sample_form_operational_workflow_inherit" model="ir.ui.view">
        <field name="name">lab.sample.form.operational.workflow.inherit</field>
        <field name="model">lab.sample</field>
        <field name="inherit_id" ref="laboratory_management.view_lab_sample_form"/>
        <field name="arch" type="xml">
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" type="object" name="action_view_workstation_tasks" icon="fa-tasks">
                    <field name="workstation_task_count" widget="statinfo" string="Tasks"/>
                </button>
            </xpath>
        </field>
    </record>

    <record id="view_lab_analysis_form_operational_workflow_inherit" model="ir.ui.view">
        <field name="name">lab.analysis.form.operational.workflow.inherit</field>
        <field name="model">lab.sample.analysis</field>
        <field name="inherit_id" ref="laboratory_management.view_lab_analysis_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='manual_review_reason_code']" position="after">
                <field name="workstation_task_count" readonly="1"/>
            </xpath>
        </field>
    </record>

    <record id="view_lab_interface_job_form_operational_workflow_inherit" model="ir.ui.view">
        <field name="name">lab.interface.job.form.operational.workflow.inherit</field>
        <field name="model">lab.interface.job</field>
        <field name="inherit_id" ref="laboratory_management.view_lab_interface_job_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='attempt_count']" position="after">
                <field name="workstation_task_count" readonly="1"/>
            </xpath>
        </field>
    </record>

    <menuitem id="menu_lab_task_board" name="Task Board" parent="menu_laboratory_operations" action="action_lab_task_board_wizard" sequence="6"/>
    <menuitem id="menu_lab_workstation_task" name="Workstation Tasks" parent="menu_laboratory_operations" action="action_lab_workstation_task" sequence="7"/>
    <menuitem id="menu_lab_interface_replay_batch" name="Interface Replay" parent="menu_laboratory_operations" action="action_lab_interface_replay_batch" sequence="8"/>

    <menuitem id="menu_lab_sop_branch_run" name="SOP Branch Runs" parent="menu_laboratory_quality" action="action_lab_sop_branch_run" sequence="42"/>

    <menuitem id="menu_lab_task_sla_policy" name="Task SLA Policies" parent="menu_laboratory_config" action="action_lab_task_sla_policy" sequence="26"/>
    <menuitem id="menu_lab_sop_branch_rule" name="SOP Branch Rules" parent="menu_laboratory_config" action="action_lab_sop_branch_rule" sequence="27"/>
</odoo>
